# 套路篇：系统监控的综合思路

!!! tips
    在实际的性能分析中，性能问题总是时不时地发生，但同时却很难找出发生规律，也很难重现。

很多时候，都是等用户抱怨响应慢了，或者系统崩溃了以后，才发现系统或者应用程序的性能出现了问题，这种严重影响用户体验的方式，是不可取的。

而解决这个问题，就需要搭建监控系统，把系统和应用程序的运行状况监控起来，并定义一系列的策略，在发生问题时第一时间告警通知。

要做好监控，最核心的就是全面的、可量化的指标，这包括系统和应用两个方面。

系统层面：需要涵盖系统的整体资源使用情况，如 CPU、内存、磁盘、文件系统和网络等各种系统资源。

应用程序层面：要涵盖应用程序内部的运行状态，既包括进程的 CPU、磁盘 I/O 等整体运行状况，更需要包括诸如接口调用耗时、执行过程中的错误、内部对象的内存使用等应用程序内部的运行状况。

## USE 法

!!! note
    USE （Utilization Saturation & Errors）法是一种专门用于性能监控的方法，它把系统资源的性能指标，简化成了三个类别，即使用率、饱和度、错误数。

    这三类指标，涵盖了系统资源的常见性能瓶颈，常被用来快速定位系统资源的性能瓶颈。

- **使用率**：表示资源用于服务的时间或容量百分比。100% 的使用率，表示容量已经用尽或者全部时间都用于服务。

- **饱和度**：表示资源的繁忙程度，通常与等待队列的长度相关。100% 的饱和度，表示资源无法接受更多的请求。

- **错误数**：表示发生错误的事件个数。错误数越多，表明系统的问题越严重。
  
### 常见指标分类（USE 法）

| 资源         | 类型   | 性能指标                         |
| ------------ | ------ | -------------------------------- |
| CPU          | 使用率 | CPU 使用率                       |
| CPU          | 饱和度 | 运行队列长度或平均负载           |
| CPU          | 错误数 | 硬件 CPU 错误数                  |
| 内存         | 使用率 | 已用内存百分比或 SWAP 用量百分比 |
| 内存         | 饱和度 | 内存换页量                       |
| 内存         | 错误数 | 内存分配失败或 OOM               |
| 存储设备 I/O | 使用率 | 设备 I/O 时间百分比              |
| 存储设备 I/O | 饱和度 | 等待队列长度或延迟               |
| 存储设备 I/O | 错误数 | I/O 错误数                       |
| 文件系统     | 使用率 | 已用容量百分比                   |
| 文件系统     | 饱和度 | 已用容量百分比                   |
| 文件系统     | 错误数 | 文件读写错误数                   |
| 网格         | 使用率 | 带宽使用率                       |
| 网格         | 饱和度 | 重传报文数                       |
| 网格         | 错误数 | 网卡收发错误数、丢包数           |
| 文件描述符   | 使用率 | 已用文件描述符数百分比           |
| 连接跟踪     | 使用率 | 已用连接跟踪数百分比             |
| 连接数       | 饱和度 | TIMEWAIT 状态连接数              |

!!! attention
    USE 方法只关注能体现系统资源性能瓶颈的核心指标，但并不是说，其他指标不重要。
    
    诸如系统日志、进程资源使用量、缓存使用量等其他各类指标，也都需要我们监控起来，只不过是通常用作辅助性能分析。

## 监控系统

!!! tips
    掌握 USE 方法 -> 定义需要监控的指标 -> 建立监控系统 -> 根据监控状态，自动分析定位大致的瓶颈来源 -> 完善告警西戎 -> 及时反馈汇报相关团队处理

    一个完整的监控系统，通常由数据采集、数据存储、数据查询和处理、告警以及可视化展示等多个模块组成。  

最常见的开源监控工具有：Zabbix、Prometheus、Nagios 等。

## 小结

系统监控的核心是资源的使用情况，包括 CPU、内存、磁盘和文件系统、网络等硬件资源，以及文件描述符数、连接数、连接跟踪数等软件资源。

上述这些资源，可以通过 USE 方法来建立核心性能指标，USE 法把系统资源的性能指标，简化为了三个类别，即使用率、饱和度以及错误数。三者任一类别过高时，都代表相对应的系统资源有可能存在性能瓶颈。

基于 USE 法建立性能指标后，还需要通过一套完整的监控系统，把这些指标从采集、存储、查询、处理，再到告警和可视化展示等，串联起来。

其中，可以采用的开源监控工具有 Zabbix、Prometheus 等。